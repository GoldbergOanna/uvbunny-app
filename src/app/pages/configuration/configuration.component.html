<div class="configuration-container">
  <!-- Loading State -->
  <div *ngIf="isLoading$ | async" class="loading-state">
    <div class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading configuration...</span>
      </div>
    </div>
    <p class="loading-text">Loading configuration...</p>
  </div>

  <!-- Configuration Content -->
  <ng-container *ngIf="!(isLoading$ | async)">
    <!-- Header -->
    <header class="page-header">
      <button
        type="button"
        class="back-button"
        (click)="goBack()"
        aria-label="Back to dashboard"
      >
        <i class="bi bi-arrow-left"></i>
        <span>Back to Dashboard</span>
      </button>
      <div class="header-content">
        <h1 class="page-title">
          <i class="bi bi-gear-fill me-2"></i>
          Configuration
        </h1>
        <p class="page-subtitle">
          Manage point values for bunny activities. Changes will recalculate all bunny happiness retroactively.
        </p>
      </div>
    </header>

    <!-- Warning Message -->
    <div class="warning-card">
      <div class="warning-icon">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </div>
      <div class="warning-content">
        <h3 class="warning-title">Important: Retroactive Changes</h3>
        <p class="warning-text">
          Changing these values will recalculate happiness for all bunnies based on their complete event history.
          This process may take a few moments for large datasets.
        </p>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div *ngIf="successMessage$ | async as message" class="alert alert-success">
      <i class="bi bi-check-circle-fill me-2"></i>
      {{ message }}
    </div>

    <div *ngIf="errorMessage$ | async as message" class="alert alert-danger">
      <i class="bi bi-exclamation-circle-fill me-2"></i>
      {{ message }}
    </div>

    <!-- Configuration Form -->
    <div class="configuration-form-card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="bi bi-sliders me-2"></i>
          Point Values
        </h2>
        <p class="card-subtitle">Configure how many happiness points each activity awards</p>
      </div>

      <form [formGroup]="configForm" class="config-form">
        <div class="row g-4">
          <!-- Lettuce Points -->
          <div class="col-12 col-md-6">
            <div class="form-group">
              <label for="lettuce" class="form-label">
                <span class="activity-icon">ðŸ¥¬</span>
                Lettuce Points
              </label>
              <div class="input-group">
                <input
                  type="number"
                  id="lettuce"
                  class="form-control"
                  formControlName="lettuce"
                  min="0"
                  placeholder="1"
                />
                <span class="input-group-text">points</span>
              </div>
              <div class="form-text">Points awarded when a bunny eats lettuce</div>
              <div *ngIf="configForm.get('lettuce')?.invalid && configForm.get('lettuce')?.touched" class="invalid-feedback d-block">
                Please enter a valid positive number
              </div>
            </div>
          </div>

          <!-- Carrot Points -->
          <div class="col-12 col-md-6">
            <div class="form-group">
              <label for="carrot" class="form-label">
                <span class="activity-icon">ðŸ¥•</span>
                Carrot Points
              </label>
              <div class="input-group">
                <input
                  type="number"
                  id="carrot"
                  class="form-control"
                  formControlName="carrot"
                  min="0"
                  placeholder="3"
                />
                <span class="input-group-text">points</span>
              </div>
              <div class="form-text">Points awarded when a bunny eats carrots</div>
              <div *ngIf="configForm.get('carrot')?.invalid && configForm.get('carrot')?.touched" class="invalid-feedback d-block">
                Please enter a valid positive number
              </div>
            </div>
          </div>

          <!-- Playing Points -->
          <div class="col-12 col-md-6">
            <div class="form-group">
              <label for="playing" class="form-label">
                <span class="activity-icon">ðŸŽ®</span>
                Playing Points
              </label>
              <div class="input-group">
                <input
                  type="number"
                  id="playing"
                  class="form-control"
                  formControlName="playing"
                  min="0"
                  placeholder="2"
                />
                <span class="input-group-text">points</span>
              </div>
              <div class="form-text">Points awarded for first-time play with a bunny friend</div>
              <div *ngIf="configForm.get('playing')?.invalid && configForm.get('playing')?.touched" class="invalid-feedback d-block">
                Please enter a valid positive number
              </div>
            </div>
          </div>

          <!-- Repeat Playing Points -->
          <div class="col-12 col-md-6">
            <div class="form-group">
              <label for="repeatPlaying" class="form-label">
                <span class="activity-icon">ðŸ”„</span>
                Repeat Playing Points
              </label>
              <div class="input-group">
                <input
                  type="number"
                  id="repeatPlaying"
                  class="form-control"
                  formControlName="repeatPlaying"
                  min="0"
                  placeholder="4"
                />
                <span class="input-group-text">points</span>
              </div>
              <div class="form-text">Bonus points for playing with the same friend again</div>
              <div *ngIf="configForm.get('repeatPlaying')?.invalid && configForm.get('repeatPlaying')?.touched" class="invalid-feedback d-block">
                Please enter a valid positive number
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button
        type="button"
        class="btn btn-outline-secondary"
        (click)="resetToDefaults()"
        [disabled]="isSaving$ | async"
      >
        <i class="bi bi-arrow-counterclockwise me-2"></i>
        Reset to Defaults
      </button>

      <button
        type="button"
        class="btn btn-info"
        (click)="previewChanges()"
        [disabled]="configForm.invalid || (isSaving$ | async) || (isCalculatingPreview$ | async)"
      >
        <i class="bi bi-eye me-2" *ngIf="!(isCalculatingPreview$ | async)"></i>
        <div class="spinner-border spinner-border-sm me-2" *ngIf="isCalculatingPreview$ | async" role="status">
          <span class="visually-hidden">Calculating...</span>
        </div>
        {{ (isCalculatingPreview$ | async) ? 'Calculating...' : 'Preview Changes' }}
      </button>

      <button
        type="button"
        class="btn btn-primary"
        (click)="saveConfiguration()"
        [disabled]="configForm.invalid || (isSaving$ | async)"
      >
        <i class="bi bi-check-lg me-2" *ngIf="!(isSaving$ | async)"></i>
        <div class="spinner-border spinner-border-sm me-2" *ngIf="isSaving$ | async" role="status">
          <span class="visually-hidden">Saving...</span>
        </div>
        {{ (isSaving$ | async) ? 'Saving...' : 'Save Configuration' }}
      </button>
    </div>

    <!-- Preview Section -->
    <div *ngIf="showPreview$ | async" class="preview-section">
      <div class="preview-header">
        <h3 class="preview-title">
          <i class="bi bi-graph-up me-2"></i>
          Impact Preview
        </h3>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="hidePreview()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <!-- Impact Statistics -->
      <div class="impact-stats">
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="bi bi-people-fill"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ (affectedBunnies$ | async)?.length || 0 }}</div>
                <div class="stat-label">Bunnies Affected</div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="bi bi-calendar-event"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ affectedEventsCount$ | async }}</div>
                <div class="stat-label">Events Recalculated</div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="bi bi-graph-up-arrow"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" [class.positive]="(averageHappinessChange$ | async)! > 0" [class.negative]="(averageHappinessChange$ | async)! < 0">
                  {{ (averageHappinessChange$ | async)! > 0 ? '+' : '' }}{{ averageHappinessChange$ | async }}%
                </div>
                <div class="stat-label">Avg Happiness Change</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bunny Happiness Previews -->
      <div class="happiness-previews" *ngIf="happinessPreviews$ | async as previews">
        <h4 class="previews-title">Individual Bunny Changes</h4>
        <div class="preview-list">
          <div
            *ngFor="let preview of previews; trackBy: trackByPreviewId"
            class="preview-item"
            [class.no-change]="mathAbs(preview.change) < 0.01"
          >
            <div class="bunny-info">
              <div class="bunny-avatar">
                <img
                  [src]="preview.bunny.avatarUrl || 'https://ui-avatars.com/api/?name=' + encodeUriComponent(preview.bunny.name) + '&background=2563eb&color=ffffff&size=40'"
                  [alt]="preview.bunny.name + ' avatar'"
                />
              </div>
              <div class="bunny-details">
                <div class="bunny-name">{{ preview.bunny.name }}</div>
                <div class="happiness-change">
                  <span class="current">{{ preview.currentHappiness }}%</span>
                  <i class="bi bi-arrow-right"></i>
                  <span class="new">{{ preview.newHappiness }}%</span>
                  <span class="change" [class.positive]="preview.change > 0" [class.negative]="preview.change < 0">
                    ({{ preview.change > 0 ? '+' : '' }}{{ mathRound(preview.change * 100) / 100 }}%)
                  </span>
                </div>
              </div>
            </div>
            <div class="change-indicator" [class.positive]="preview.change > 0" [class.negative]="preview.change < 0">
              <i class="bi bi-arrow-up" *ngIf="preview.change > 0"></i>
              <i class="bi bi-arrow-down" *ngIf="preview.change < 0"></i>
              <i class="bi bi-dash" *ngIf="mathAbs(preview.change) < 0.01"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>