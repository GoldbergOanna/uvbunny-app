# This file was auto-generated by the Firebase CLI and modified for secure environment management
# https://github.com/firebase/firebase-tools
#
# Required GitHub Secrets (set in repository Settings > Secrets and variables > Actions):
# - FIREBASE_API_KEY: Your Firebase API key
# - FIREBASE_AUTH_DOMAIN: Your Firebase auth domain
# - FIREBASE_PROJECT_ID: Your Firebase project ID
# - FIREBASE_STORAGE_BUCKET: Your Firebase storage bucket
# - FIREBASE_MESSAGING_SENDER_ID: Your Firebase messaging sender ID
# - FIREBASE_APP_ID: Your Firebase app ID
# - FIREBASE_MEASUREMENT_ID: Your Firebase measurement ID
# - FIREBASE_SERVICE_ACCOUNT_UVBUNNY_APP: Firebase service account key (JSON)

name: Deploy to Firebase Hosting on PR
on: pull_request

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  build_and_preview:
    # Only run for PRs from the same repository (security measure)
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Validate required secrets
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_UVBUNNY_APP_2025 }}
        run: |
          echo "üîç Validating required GitHub Secrets for PR preview..."
          MISSING_SECRETS=()

          # Check required secrets using environment variables for safe handling
          if [[ -z "${FIREBASE_API_KEY}" ]]; then
            MISSING_SECRETS+=("FIREBASE_API_KEY")
          fi
          if [[ -z "${FIREBASE_AUTH_DOMAIN}" ]]; then
            MISSING_SECRETS+=("FIREBASE_AUTH_DOMAIN")
          fi
          if [[ -z "${FIREBASE_PROJECT_ID}" ]]; then
            MISSING_SECRETS+=("FIREBASE_PROJECT_ID")
          fi
          if [[ -z "${FIREBASE_STORAGE_BUCKET}" ]]; then
            MISSING_SECRETS+=("FIREBASE_STORAGE_BUCKET")
          fi
          if [[ -z "${FIREBASE_MESSAGING_SENDER_ID}" ]]; then
            MISSING_SECRETS+=("FIREBASE_MESSAGING_SENDER_ID")
          fi
          if [[ -z "${FIREBASE_APP_ID}" ]]; then
            MISSING_SECRETS+=("FIREBASE_APP_ID")
          fi
          if [[ -z "${FIREBASE_SERVICE_ACCOUNT}" ]]; then
            MISSING_SECRETS+=("FIREBASE_SERVICE_ACCOUNT_UVBUNNY_APP")
          fi

          # FIREBASE_MEASUREMENT_ID is optional for Google Analytics
          if [[ -z "${FIREBASE_MEASUREMENT_ID}" ]]; then
            echo "‚ö†Ô∏è  FIREBASE_MEASUREMENT_ID is not set (Google Analytics will be disabled)"
          fi

          if [[ ${#MISSING_SECRETS[@]} -ne 0 ]]; then
            echo "‚ùå Missing required GitHub Secrets:"
            printf "%s\n" "${MISSING_SECRETS[@]}"
            echo ""
            echo "Please add these secrets in repository Settings > Secrets and variables > Actions"
            echo "See .github/secrets-setup.md for detailed instructions"
            exit 1
          fi

          echo "‚úÖ All required secrets are configured"

      - name: Install dependencies
        run: npm ci
        env:
          NODE_ENV: development

      - name: Create environment files from secrets
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "üîß Creating environment files from GitHub Secrets for PR preview..."

          # Validate that all required environment variables are set
          if [[ -z "${FIREBASE_API_KEY}" || -z "${FIREBASE_AUTH_DOMAIN}" || -z "${FIREBASE_PROJECT_ID}" || -z "${FIREBASE_STORAGE_BUCKET}" || -z "${FIREBASE_MESSAGING_SENDER_ID}" || -z "${FIREBASE_APP_ID}" ]]; then
            echo "‚ùå One or more required Firebase environment variables are missing"
            echo "This should have been caught in the validation step"
            exit 1
          fi

          # Set fallback for optional measurement ID
          MEASUREMENT_ID="${FIREBASE_MEASUREMENT_ID:-\"\"}"
          if [[ -z "${FIREBASE_MEASUREMENT_ID}" ]]; then
            echo "‚ÑπÔ∏è  Using empty string for measurementId (Google Analytics disabled)"
          else
            MEASUREMENT_ID="\"${FIREBASE_MEASUREMENT_ID}\""
          fi

          # Ensure environments directory exists
          echo "üìÅ Creating environments directory..."
          mkdir -p src/environments

          if [[ ! -d "src/environments" ]]; then
            echo "‚ùå Failed to create src/environments directory"
            exit 1
          fi

          echo "‚úÖ Directory src/environments/ created successfully"

          # Create production environment file with proper TypeScript structure
          echo "üìù Creating production environment file for PR preview..."

          # Create environment file using heredoc to avoid shell interpolation issues
          cat > src/environments/environment.prod.ts << 'EOF'
// Generated automatically from GitHub Secrets during CI/CD (PR Preview)
// DO NOT EDIT - This file is created during the build process

export const environment = {
  production: true,
  firebase: {
EOF

          # Add Firebase configuration with proper escaping and single quotes
          # Escape any single quotes in the secret values to prevent syntax errors
          API_KEY_ESCAPED=$(echo "${FIREBASE_API_KEY}" | sed "s/'/\\\\'/g")
          AUTH_DOMAIN_ESCAPED=$(echo "${FIREBASE_AUTH_DOMAIN}" | sed "s/'/\\\\'/g")
          PROJECT_ID_ESCAPED=$(echo "${FIREBASE_PROJECT_ID}" | sed "s/'/\\\\'/g")
          STORAGE_BUCKET_ESCAPED=$(echo "${FIREBASE_STORAGE_BUCKET}" | sed "s/'/\\\\'/g")
          MESSAGING_SENDER_ID_ESCAPED=$(echo "${FIREBASE_MESSAGING_SENDER_ID}" | sed "s/'/\\\\'/g")
          APP_ID_ESCAPED=$(echo "${FIREBASE_APP_ID}" | sed "s/'/\\\\'/g")

          # Handle optional measurement ID
          if [[ -n "${FIREBASE_MEASUREMENT_ID}" ]]; then
            MEASUREMENT_ID_ESCAPED=$(echo "${FIREBASE_MEASUREMENT_ID}" | sed "s/'/\\\\'/g")
            MEASUREMENT_LINE="    measurementId: '${MEASUREMENT_ID_ESCAPED}'"
          else
            MEASUREMENT_LINE="    measurementId: ''"
          fi

          # Write the Firebase configuration properties
          cat >> src/environments/environment.prod.ts << EOF
    apiKey: '${API_KEY_ESCAPED}',
    authDomain: '${AUTH_DOMAIN_ESCAPED}',
    projectId: '${PROJECT_ID_ESCAPED}',
    storageBucket: '${STORAGE_BUCKET_ESCAPED}',
    messagingSenderId: '${MESSAGING_SENDER_ID_ESCAPED}',
    appId: '${APP_ID_ESCAPED}',
${MEASUREMENT_LINE}
EOF

          # Close the environment object
          cat >> src/environments/environment.prod.ts << 'EOF'
  }
};
EOF

          # Verify production file was created
          if [[ ! -f "src/environments/environment.prod.ts" ]]; then
            echo "‚ùå Failed to create environment.prod.ts"
            exit 1
          fi

          echo "‚úÖ Production environment file created successfully"

          # Create development environment file with proper TypeScript structure
          echo "üìù Creating development environment file for PR preview..."

          # Create environment file using heredoc to avoid shell interpolation issues
          cat > src/environments/environment.ts << 'EOF'
// Generated automatically from GitHub Secrets during CI/CD (PR Preview)
// DO NOT EDIT - This file is created during the build process

export const environment = {
  production: false,
  firebase: {
EOF

          # Use the same escaped variables from production environment
          # Write the Firebase configuration properties
          cat >> src/environments/environment.ts << EOF
    apiKey: '${API_KEY_ESCAPED}',
    authDomain: '${AUTH_DOMAIN_ESCAPED}',
    projectId: '${PROJECT_ID_ESCAPED}',
    storageBucket: '${STORAGE_BUCKET_ESCAPED}',
    messagingSenderId: '${MESSAGING_SENDER_ID_ESCAPED}',
    appId: '${APP_ID_ESCAPED}',
${MEASUREMENT_LINE}
EOF

          # Close the environment object
          cat >> src/environments/environment.ts << 'EOF'
  }
};
EOF

          # Verify development file was created
          if [[ ! -f "src/environments/environment.ts" ]]; then
            echo "‚ùå Failed to create environment.ts"
            exit 1
          fi

          echo "‚úÖ Development environment file created successfully"
          echo "‚úÖ All environment files created successfully for PR preview"

      - name: Verify environment files
        run: |
          echo "üîç Verifying generated environment files for PR preview..."

          if [ ! -f "src/environments/environment.ts" ]; then
            echo "‚ùå environment.ts was not created"
            exit 1
          fi

          if [ ! -f "src/environments/environment.prod.ts" ]; then
            echo "‚ùå environment.prod.ts was not created"
            exit 1
          fi

          # Check if files contain the expected structure (without revealing secrets)
          if grep -q "export const environment" src/environments/environment.ts && \
             grep -q "production: false" src/environments/environment.ts; then
            echo "‚úÖ environment.ts has correct structure"
          else
            echo "‚ùå environment.ts has incorrect structure"
            exit 1
          fi

          if grep -q "export const environment" src/environments/environment.prod.ts && \
             grep -q "production: true" src/environments/environment.prod.ts; then
            echo "‚úÖ environment.prod.ts has correct structure"
          else
            echo "‚ùå environment.prod.ts has incorrect structure"
            exit 1
          fi

      - name: Validate TypeScript syntax
        run: |
          echo "üîç Validating TypeScript syntax of generated environment files for PR preview..."

          # Install TypeScript if not already available
          if ! command -v tsc &> /dev/null; then
            echo "üì¶ Installing TypeScript for syntax validation..."
            npm install -g typescript
          fi

          # Validate TypeScript syntax without compilation
          echo "Checking environment.ts..."
          if tsc --noEmit --target es2015 src/environments/environment.ts; then
            echo "‚úÖ environment.ts has valid TypeScript syntax"
          else
            echo "‚ùå environment.ts has TypeScript syntax errors"
            echo "File contents (first 20 lines):"
            head -20 src/environments/environment.ts
            exit 1
          fi

          echo "Checking environment.prod.ts..."
          if tsc --noEmit --target es2015 src/environments/environment.prod.ts; then
            echo "‚úÖ environment.prod.ts has valid TypeScript syntax"
          else
            echo "‚ùå environment.prod.ts has TypeScript syntax errors"
            echo "File contents (first 20 lines):"
            head -20 src/environments/environment.prod.ts
            exit 1
          fi

          echo "‚úÖ All environment files have valid TypeScript syntax"

      - name: Debug environment file
        run: |
          echo "üîç Debugging generated environment files for PR preview..."
          echo ""
          echo "=== Generated environment.prod.ts ==="
          cat src/environments/environment.prod.ts
          echo "=== End of production file ==="
          echo ""
          echo "=== Generated environment.ts ==="
          cat src/environments/environment.ts
          echo "=== End of development file ==="
          echo ""
          echo "üìä File sizes:"
          ls -la src/environments/

      - name: Build application for preview
        run: |
          echo "üèóÔ∏è Building application for PR preview..."
          npm run build

      - name: Deploy to Firebase Hosting Preview
        uses: FirebaseExtended/action-hosting-deploy@v0
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_UVBUNNY_APP_2025 }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_UVBUNNY_APP_2025 }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Cleanup environment files
        if: always()
        run: |
          echo "üßπ Cleaning up generated environment files..."
          rm -f src/environments/environment.ts
          rm -f src/environments/environment.prod.ts
          echo "‚úÖ Cleanup completed"
